/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as t,jsxs as v,Fragment as ue}from"@dropins/tools/preact-jsx-runtime.js";import{useState as u,useEffect as S,useCallback as P}from"@dropins/tools/preact-compat.js";import{classes as ve,Slot as ne}from"@dropins/tools/lib.js";import{events as G}from"@dropins/tools/event-bus.js";import{Price as w,Input as Qe,Modal as he,Table as Ie,TextArea as _e,Button as oe,InLineAlert as E}from"@dropins/tools/components.js";/* empty css                 */import{I as ie,Q as Le,P as Te}from"./QuotePricesSummary.js";import{C as se}from"./ConfirmationModal.js";/* empty css                *//* empty css                          *//* empty css                  */import{useText as ce}from"@dropins/tools/i18n.js";import"./state.js";import{u as re,s as Be,r as ke}from"./setLineItemNote.js";import{S as le,a as J}from"./WarningFilled.js";const xe=({className:F,open:N,item:i,onClose:M,onConfirm:p,isSubmitting:d=!1,errorBanner:U,successBanner:n,showCloseButton:B=!0})=>{const[Q,h]=u(""),[c,_]=u(i.quantity),[b,y]=u({}),r=ce({title:"NegotiableQuote.Manage.lineItemNote.title",productLabel:"NegotiableQuote.Manage.lineItemNote.productLabel",skuLabel:"NegotiableQuote.Manage.lineItemNote.skuLabel",priceLabel:"NegotiableQuote.Manage.lineItemNote.priceLabel",stockLabel:"NegotiableQuote.Manage.lineItemNote.stockLabel",quantityLabel:"NegotiableQuote.Manage.lineItemNote.quantityLabel",discountLabel:"NegotiableQuote.Manage.lineItemNote.discountLabel",subtotalLabel:"NegotiableQuote.Manage.lineItemNote.subtotalLabel",noteLabel:"NegotiableQuote.Manage.lineItemNote.noteLabel",notePlaceholder:"NegotiableQuote.Manage.lineItemNote.notePlaceholder",noteHelper:"NegotiableQuote.Manage.lineItemNote.noteHelper",confirmButton:"NegotiableQuote.Manage.lineItemNote.confirmButton",cancelButton:"NegotiableQuote.Manage.lineItemNote.cancelButton",noteError:"NegotiableQuote.Manage.lineItemNote.noteError",quantityError:"NegotiableQuote.Manage.lineItemNote.quantityError"});S(()=>{var l;if(N){const g=((l=i.noteFromBuyer)==null?void 0:l.filter(H=>H&&H.note))||[],x=g.length>0?g[0].note:"";h(x||""),_(i.quantity),y({})}},[N,i.quantity,i.noteFromBuyer]);const C=P(()=>{const l={};if(Q.trim()||(l.note=r.noteError),c<=0&&(l.quantity=r.quantityError),Object.keys(l).length>0){y(l);return}p(Q.trim(),c)},[Q,c,p,r]),k=P(()=>{h(""),_(i.quantity),y({}),M==null||M()},[M,i.quantity]);if(!N)return null;const L=i.discounts&&i.discounts.length>0?i.discounts.map(l=>l.label).join(", "):"-",f=[{label:r.productLabel,key:"productName"},{label:r.priceLabel,key:"price"},{label:r.stockLabel,key:"stock"},{label:r.quantityLabel,key:"quantity"},{label:r.discountLabel,key:"discount"},{label:r.subtotalLabel,key:"subtotal"}],j=[{productName:v("div",{className:"quote-management-line-item-note-modal__product-info",children:[t("div",{className:"quote-management-line-item-note-modal__product-name",children:i.product.name}),v("div",{className:"quote-management-line-item-note-modal__product-sku",children:[r.skuLabel,": ",i.product.sku]})]}),price:t(w,{amount:i.prices.originalItemPrice.value,currency:i.prices.originalItemPrice.currency}),stock:t("span",{className:"quote-management-line-item-note-modal__stock",children:i.stockStatus}),quantity:t(Qe,{name:"quantity",type:"number",min:"1",value:c.toString(),onInput:l=>{const g=parseInt(l.target.value,10)||0;_(g),y({...b,quantity:void 0})},disabled:d,error:!!b.quantity,required:!0,"data-testid":"line-item-note-quantity-input",className:"quote-management-line-item-note-modal__quantity-input"}),discount:t("span",{className:"quote-management-line-item-note-modal__discount",children:L}),subtotal:t(w,{amount:i.prices.rowTotal.value,currency:i.prices.rowTotal.currency})}];return v(he,{open:N,size:"medium",title:t(ue,{children:r.title}),onClose:k,clickToDismiss:!0,escapeToDismiss:!0,showCloseButton:B,className:ve(["quote-management-line-item-note-modal",F]),"data-testid":"line-item-note-modal",children:[U&&t("div",{className:"quote-management-line-item-note-modal__error-banner","data-testid":"line-item-note-modal-error-banner",children:U}),n&&t("div",{className:"quote-management-line-item-note-modal__success-banner","data-testid":"line-item-note-modal-success-banner",children:n}),v("div",{className:"quote-management-line-item-note-modal__content",children:[v("div",{className:"quote-management-line-item-note-modal__details",children:[t(Ie,{columns:f,rowData:j,"data-testid":"line-item-note-table",mobileLayout:"stacked",className:"quote-management-line-item-note-modal__details-table"}),b.quantity&&t("div",{className:"quote-management-line-item-note-modal__table-error",children:b.quantity})]}),v("div",{className:"quote-management-line-item-note-modal__form-field",children:[t(_e,{name:"note",placeholder:r.notePlaceholder,rows:4,value:Q,onInput:l=>{h(l.target.value),y({...b,note:void 0})},label:r.noteLabel,disabled:d,"data-testid":"line-item-note-textarea"}),!b.note&&t("span",{className:"quote-management-line-item-note-modal__helper-text",children:r.noteHelper}),b.note&&t("span",{className:"quote-management-line-item-note-modal__error-text",children:b.note})]})]}),v("div",{className:"quote-management-line-item-note-modal__actions",children:[t(oe,{variant:"secondary",size:"medium",onClick:k,disabled:d,className:"quote-management-line-item-note-modal__cancel-button","data-testid":"line-item-note-cancel-button",children:r.cancelButton}),t(oe,{variant:"primary",size:"medium",onClick:C,disabled:d,className:"quote-management-line-item-note-modal__confirm-button","data-testid":"line-item-note-confirm-button",children:r.confirmButton})]})]})},Ee=3e3,Ge=({quoteData:F,onItemCheckboxChange:N,onItemDropdownChange:i,onRemoveItemsRef:M,onRemoveModalStateChange:p,slots:d,...U})=>{const[n,B]=u(F),[Q,h]=u({}),[c,_]=u(null),[b,y]=u(!1),[r,C]=u(!1),[k,D]=u(""),[L,f]=u({type:null,message:""}),[j,l]=u(!1),[g,x]=u([]),[H,A]=u(!1),[O,I]=u({type:null,message:""}),[K,q]=u({}),[me,z]=u(!1),s=ce({subtotal:"NegotiableQuote.Manage.quotePricesSummary.subtotal.excludingTax",grandTotal:"NegotiableQuote.Manage.quotePricesSummary.grandTotal.includingTax",appliedTaxes:"NegotiableQuote.Manage.quotePricesSummary.appliedTaxes",modalTitle:"NegotiableQuote.Manage.updateQuantitiesModal.title",modalDescription:"NegotiableQuote.Manage.updateQuantitiesModal.description",modalCancelButton:"NegotiableQuote.Manage.updateQuantitiesModal.cancelButton",modalUpdateButton:"NegotiableQuote.Manage.updateQuantitiesModal.updateButton",successHeading:"NegotiableQuote.Manage.updateQuantitiesModal.successHeading",successMessage:"NegotiableQuote.Manage.updateQuantitiesModal.successMessage",errorHeading:"NegotiableQuote.Manage.updateQuantitiesModal.errorHeading",errorMessage:"NegotiableQuote.Manage.updateQuantitiesModal.errorMessage",removeModalTitle:"NegotiableQuote.Manage.removeItemsModal.title",removeModalDescription:"NegotiableQuote.Manage.removeItemsModal.description",removeModalCancelButton:"NegotiableQuote.Manage.removeItemsModal.cancelButton",removeModalConfirmButton:"NegotiableQuote.Manage.removeItemsModal.confirmButton",removeModalConfirmButtonRemoving:"NegotiableQuote.Manage.removeItemsModal.confirmButtonRemoving",removeSuccessHeading:"NegotiableQuote.Manage.removeItemsModal.successHeading",removeSuccessMessage:"NegotiableQuote.Manage.removeItemsModal.successMessage",removeErrorHeading:"NegotiableQuote.Manage.removeItemsModal.errorHeading",removeErrorMessage:"NegotiableQuote.Manage.removeItemsModal.errorMessage"});S(()=>{const a=G.on("quote-management/quote-data",e=>{B(e.quote),h({}),f({type:null,message:""}),q({})},{eager:!0});return()=>a==null?void 0:a.off()},[]),S(()=>{const a=G.on("quote-management/quantities-updated",e=>{B(e.quote),h({}),f({type:"success",message:s.successMessage}),setTimeout(()=>{y(!1),f({type:null,message:""})},3e3)});return()=>a==null?void 0:a.off()},[s.successMessage]),S(()=>{const a=G.on("quote-management/quote-items-removed",e=>{B(e.quote),x([]),A(!1),I({type:"success",message:s.removeSuccessMessage}),setTimeout(()=>{l(!1),I({type:null,message:""}),p==null||p(!1)},Ee)});return()=>a==null?void 0:a.off()},[s.removeSuccessMessage,p]);const W=P(a=>{!a||a.length===0||(x(a),I({type:null,message:""}),l(!0))},[]);S(()=>{M==null||M(W)},[W,M]);const V=()=>{I({type:null,message:""})},X=(a,e)=>{const o=a;if(e==="edit"){_(o),C(!0),q(m=>({...m,[o.uid]:""}));return}if(e==="remove"){q(m=>({...m,[o.uid]:e})),W([o]),i==null||i(o,e),q(m=>({...m,[o.uid]:""}));return}e&&(i==null||i(o,e)),q(m=>{if(!(o.uid in m))return m;const T={...m};return delete T[o.uid],T})},de=async()=>{if(!n||g.length===0)return;const a=g.map(e=>e.uid);A(!0),I({type:null,message:""});try{await ke({quoteUid:n.uid,quoteItemUids:a})}catch(e){const o=e instanceof Error?e.message:s.removeErrorMessage;if(I({type:"error",message:o}),g.length===1){const m=g[0];q(T=>{if(!(m.uid in T))return T;const ae={...T};return delete ae[m.uid],ae})}A(!1)}},ge=()=>{if(l(!1),I({type:null,message:""}),p==null||p(!1),g.length===1){const a=g[0];q(e=>{if(!(a.uid in e))return e;const o={...e};return delete o[a.uid],o})}x([])},Y=P(()=>{c&&q(a=>{const e={...a};return delete e[c.uid],e}),C(!1),_(null),z(!1),D("")},[c]),pe=P(async(a,e)=>{if(!(!c||!n)){z(!0);try{e!==c.quantity&&await re({quoteUid:n.uid,items:[{quoteItemUid:c.uid,quantity:e}]}),await Be({quoteUid:n.uid,itemUid:c.uid,note:a,quantity:e}),Y()}catch(o){console.error("Failed to set line item note:",o);const m=o instanceof Error?o.message:"Unable to update the item. Please try again.";D(m),z(!1)}}},[c,n,Y]);if(!n)return t(ie,{loading:!0});const Z=!!n.canUpdateQuote,R=(a,e)=>{h(o=>({...o,[a.uid]:e}))},ee=a=>{a.preventDefault(),f({type:null,message:""}),y(!0)},be=async()=>{if(!n)return;if(Object.keys(Q).length===0){y(!1);return}f({type:null,message:""});const a=Object.entries(Q).map(([e,o])=>({quoteItemUid:e,quantity:o}));try{await re({quoteUid:n.uid,items:a})}catch(e){const o=e instanceof Error?e.message:s.errorMessage;f({type:"error",message:o}),console.error("Failed to update quantities:",e)}},ye=()=>{y(!1),f({type:null,message:""})},te=()=>{f({type:null,message:""})},$=[];n.prices.subtotalExcludingTax&&$.push({label:s.subtotal,id:"subtotal",value:t(w,{amount:n.prices.subtotalExcludingTax.value,currency:n.prices.subtotalExcludingTax.currency,weight:"normal"})}),n.prices.grandTotal&&$.push({label:s.grandTotal,id:"total",value:t(w,{amount:n.prices.grandTotal.value,currency:n.prices.grandTotal.currency}),strong:!0});const fe=L.type==="success"?t(E,{type:"success",variant:"primary",icon:t(le,{}),heading:s.successHeading,description:L.message,onDismiss:te,"data-testid":"update-quantities-success-banner"}):L.type==="error"?t(E,{type:"error",variant:"primary",icon:t(J,{}),heading:s.errorHeading,description:L.message,onDismiss:te,"data-testid":"update-quantities-error-banner"}):null,Me=N?(a,e)=>{N(a,e)}:void 0,Ne=O.type==="success"?t(E,{type:"success",variant:"primary",icon:t(le,{}),heading:s.removeSuccessHeading,description:O.message,onDismiss:V,"data-testid":"remove-items-success-banner"}):O.type==="error"?t(E,{type:"error",variant:"primary",icon:t(J,{}),heading:s.removeErrorHeading,description:O.message,onDismiss:V,"data-testid":"remove-items-error-banner"}):null,qe=k?t(E,{type:"error",variant:"primary",icon:t(J,{}),heading:s.errorHeading,description:k,onDismiss:()=>D(""),"data-testid":"line-item-note-error-banner"}):null;return v(ue,{children:[t(ie,{"data-testid":"items-quoted-container",...U,loading:!1,table:t(ne,{name:"ProductListTable",slot:d==null?void 0:d.ProductListTable,context:{items:n.items,canEdit:Z,readOnly:n.readOnly,onItemCheckboxChange:N,onItemDropdownChange:X,onQuantityChange:R,onUpdate:ee,dropdownSelections:K},children:t(Te,{items:n.items,canEdit:Z,onItemCheckboxChange:Me,readOnly:n.readOnly,onItemDropdownChange:X,onQuantityChange:R,onUpdate:ee,dropdownSelections:K})}),pricesSummary:t(ne,{name:"QuotePricesSummary",slot:d==null?void 0:d.QuotePricesSummary,context:{items:n.items,prices:n.prices},children:t(Le,{entries:$})})}),t(se,{open:b,title:s.modalTitle,message:s.modalDescription,cancelLabel:s.modalCancelButton,confirmLabel:s.modalUpdateButton,onCancel:ye,onConfirm:be,confirmationBanner:fe,"data-testid":"update-quantities-modal"}),t(se,{open:j,title:s.removeModalTitle,message:s.removeModalDescription,cancelLabel:s.removeModalCancelButton,confirmLabel:H?s.removeModalConfirmButtonRemoving:s.removeModalConfirmButton,onCancel:ge,onConfirm:de,confirmationBanner:Ne,"data-testid":"remove-items-modal"}),c&&t(xe,{open:r,item:c,onClose:Y,onConfirm:pe,isSubmitting:me,errorBanner:qe||void 0})]})};export{Ge as I};
//# sourceMappingURL=ItemsQuoted.js.map
